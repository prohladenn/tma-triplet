services:
  # Backend API service
  backend:
    build:
      context: ..
      dockerfile: infra/backend.Dockerfile
    container_name: tma-backend
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_BOT_ID=${TELEGRAM_BOT_ID}
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "-O",
          "/dev/null",
          "http://localhost:3000/health",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - tma-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Frontend service
  frontend:
    build:
      context: ..
      dockerfile: infra/frontend.Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-http://localhost:3000/api}
    container_name: tma-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "-O",
          "/dev/null",
          "http://127.0.0.1/",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - tma-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Telegram Echo Bot - DISABLED
  # bot:
  #   build:
  #     context: ..
  #     dockerfile: infra/bot.Dockerfile
  #   container_name: tma-bot
  #   ports:
  #     - "3001:3001"
  #   environment:
  #     - PORT=3001
  #     - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
  #     - WEBHOOK_URL=${WEBHOOK_URL:-}
  #   restart: unless-stopped
  #   healthcheck:
  #     test:
  #       [
  #         "CMD",
  #         "wget",
  #         "--no-verbose",
  #         "--tries=1",
  #         "-O",
  #         "/dev/null",
  #         "http://localhost:3001/health",
  #       ]
  #     interval: 30s
  #     timeout: 3s
  #     retries: 3
  #     start_period: 10s
  #   networks:
  #     - tma-network
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

networks:
  tma-network:
    driver: bridge
